---
layout: post
title: Ajax异步交互
author: AllenYang
tagpic: ajax.png
category: other
description: 从今日起正式开始写博客，每日一篇，聊一聊技术，谈谈诗和远方

---

## Ajax简介

AJAX即"Asynchronous Javascript And XML"(异步JavaScript和XML),通常我们在进行网页数据的更新的时候，必须要进行网页的刷新，非常影响使用者的体验，AJAX 可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。

下面将介绍Ajax的使用方法:


### 1，创建Ajax对象

在创建Ajax对象的时候，需要考虑兼容性问题

在标准浏览器下，创建对象

	xhr = new XMLHttpRequest();

在IE浏览器下创建对象:

	xhr = new ActiveXObject('Microsoft.XMLHTTP');

整合上面的代码，我们可以使用if语句判断，也可以使用try，catch语句进行判断：

	try{
		xhr = new XMLHttpRequest(); 
	}catch(e){
		xhr = new ActiveXObject('Microsoft.XMLHTTP');
	}

### 2,规定请求的类型、URL 以及是否异步处理请求

	open(method,url,bool);

method代表发送请求的类型，在Ajax中请求类型分为'GET','POST'两种:

与POST相比,GET更简单也更快,并且在大部分情况下都能用。

然而,在以下情况中,请使用 POST 请求:

* 无法使用缓存文件（更新服务器上的文件或数据库）
* 向服务器发送大量数据（POST 没有数据量限制）
* 发送包含未知字符的用户输入时，POST 比 GET 更稳定也更可靠

url参数代表服务器上文件的地址。

如果请求数据的方式为GET，请求数据要直接加在'?'之后,在这里做一下兼容处理:

	if( method == 'get' && data ){
		url += '?' + data;
	}

bool参数为'true'或者'false':

* 'true'代表异步
* 'false'代表同步

异步是Ajax巨大的优势:通过异步，我们可以在等待服务器响应时执行其他脚本，当响应就绪后对响应进行处理


### 3,将请求发送到服务器

	send();

但是在POST方式中，发送的请求数据需要作为send的参数传出:

	if( method == 'get'){
		xhr.send();
	}else{
		//为了统一数据的编码，请加上HTTP头。
		xhr.setRequestHeader('content-type','application/x-www-form-urlencoded');
		xhr.send(data);
	}



### 4,最后一步,响应

我们通过，onreadystatechange 事件来监听，每当readyState 改变的时候都会触发这个事件,当触发事件的时候，使用readyState和status判断请求是否正常:

readyState : 存有 XMLHttpRequest 的状态。从 0 到 4 发生变化:

* 0: 请求未初始化
* 1: 服务器连接已建立
* 2: 请求已接收
* 3: 请求处理中
* 4: 请求已完成，且响应已就绪

status	: HTTP服务器状态代码,这里列出了两个常见的:

* 200: "OK"
* 404: 未找到页面


下面是收到响应的代码:

	xhr.onreadystatechange = function () {
		if( xhr.readyState == 4){

			if( xhr.status == 200){
				success && success(xhr.responseText);
			}else{	
				alert('Error:' + xhr.status);
			}
		}
	}

到这里，一个完整的请求就已经完成了。

xhr.responseText代表返回的数据。我们可以封装一个success函数,将返回的信息当做参数进行处理就可以了。


下面我们将Ajax整个过程进行封装，提高代码的复用性:

	function ajax( method,url,data,success ) {

		var xhr = null;
		
		try{
			xhr = new XMLHttpRequest();
		}catch(e){
			xhr = new ActiveXObject('Microsoft.XMLHTTP');
		}E

		if( method == 'get' && data ) {
			url += '?' + data; 
		}

		xhr.open(method,url,true);
		if(method == 'get'){
			xhr.send();
		}else{
			xhr.setRequestHeader('content-type','application/x-www-form-urlencoded');
			xhr.send(data);
		}

		xhr.onreadystatechange = function() {

			if( xhr.readyState == 4){

				if( xhr.status == 200){
					success && success(xhr.responseText);
				}else{	
					alert('Error:' + xhr.status);
				}
			}
		}

	}


